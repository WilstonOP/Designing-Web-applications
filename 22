<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="../styles.css">
</head>

<body>
  <div class="tab-links">
    <div class="tab-link" onclick="openTab(event, 'form-tab')">Форма</div>
    <div class="tab-link" onclick="openTab(event, 'chart-tab')">Графики</div>
  </div>

  <div id="form-tab" class="tab active">
    <div class="container">
      <h2 class="title">Форма ввода данных</h2>
      <div class="form-container">
        <form action="/" method="POST">
          <label for="name">ФИО:</label>
          <input type="text" id="name" name="name"><br><br>
          <label for="phone">Номер телефона:</label>
          <input type="text" id="phone" name="phone" required><br><br>
          <label for="email">Email:</label>
          <input type="email" id="email" name="email" required><br><br>
          <label for="message">Сообщение:</label>
          <textarea id="message" name="message" required></textarea><br><br>
          <label for="messageType">Тип сообщения:</label>
          <select id="messageType" name="messageType" required>
            <option value="general">Общая консультация</option>
            <option value="purchase">Покупка</option>
            <option value="sale">Продажа</option>
          </select><br><br>
          <input type="submit" value="Отправить">
        </form>
      </div>
    </div>
  </div>

  

  <div id="chart-tab" class="tab">
    <h2>Графики</h2>
    <h3 id="chart-title">Количество заявок в день</h3>
    <canvas id="myChart"></canvas>

    <h3 id="message-type-chart-title">Количество заявок по типу</h3>
    <canvas id="messageTypeChart"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
const form = document.querySelector('form');
form.addEventListener('submit', (event) => {
  event.preventDefault();
  form.submit();
});


    fetch('/requests-per-day')
      .then(response => response.json())
      .then(data => {
        if (data.length === 0) {
          document.getElementById('myChart').style.display = 'none';
          document.getElementById('chart-title').innerText = 'Нет данных для отображения';
        } else {
          const labels = data.map(item => item._id);
          const values = data.map(item => item.count);

          const ctx = document.getElementById('myChart').getContext('2d');
          const myChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Количество заявок',
                data: values,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        }
      });

    fetch('/message-type-count')
      .then(response => response.json())
      .then(data => {
        if (Object.keys(data).length === 0) {
          document.getElementById('messageTypeChart').style.display = 'none';
          document.getElementById('message-type-chart-title').innerText = 'Нет данных для отображения';
        } else {
          const labels = Object.keys(data);
          const values = Object.values(data);

          const ctx = document.getElementById('messageTypeChart').getContext('2d');
          const messageTypeChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Количество заявок',
                data: values,
                backgroundColor: 'rgba(192, 75, 192, 0.2)',
                borderColor: 'rgba(192, 75, 192, 1)',
                borderWidth: 1
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        }
      });

    function openTab(event, tabName) {
      const tabs = document.getElementsByClassName('tab');
      for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
      }
      document.getElementById(tabName).classList.add('active');
    }
  </script>
</body>
</html>
